# 浅谈前端测试

## 前端单元测试是什么

为检测特定的目标是否符合标准而采用专用的工具或者方法进行验证,并最终得出特定的结果;或者是一个单元测试是用于判断某个特定条件(或者场景)下某个特定函数的行为

## 测试分类

### 单元测试

针对程序最小单位进行测试,可以是一个函数,过程或是一个oop;单元测试是极限编程的基础,有很强的错误隔离能力,方便快速定位问题.同时由于其低向上的测试路径,使得软件集成变得简单.缺点是不能发现集成错误和性能问题

### 集成测试

在单元测试基础上,集成多个模块,组成系统或子系统

### 端到端测试

在终端上以用户视角(黑盒)测试产品的整体质量,如业务逻辑,UI等,这个阶段的测试结果更能贴近产品的最终形态,一般是正式或者准正式编写端到端测试成本会比较高，首先是需要花费更多的时间在依赖集成上，其次是运行环境复杂，比如大量的异步操作需要被处理，以及很多时候我们并没有一个完整的后端沙箱链路可以用来测试

## 单元测试

### 为什么需要单元测试

期的几个月发布一次，已经跟不上业务扩张的步伐。对需求更快研发，更快调整，是决定业务成败的生命线。如果没有严格的测试来验证软件的正确性，开发者将**难以快速回归代码**，导致的结果就是**不敢重构**（最近团队也有类似的困境），只能不断往上堆叠，最终代码腐化，然后在某个时刻崩塌。



### 如何写单元测试

#### 原则

- 自动化：单元测试应该是全自动执行的，并且非交互式的。利用断言`Assert`进行结果验证。

- 独立性：保持单元测试的独立性。为了保证单元测试稳定可靠且便于维护，单元测试用例之间决不能互相调用，也不能依赖执行的先后次序。 单测不负责检查跨类或者跨系统的交互逻辑，那是集成测试的领域。

- 可重复：单元测试是可以重复执行的，不能受到外界环境的影响。如果单测对外部环境(网络、服务、中间件等)有依赖，容易导致持续集成机制的不可用。

- 全面性：除了正确的输入得到预期的结果，还需要强制错误信息输入得到预期的结果，为了系统的鲁棒性，应加入边界值测试，包括循环边界、特殊取值、特殊时间点、数据顺序等。

- 细粒度：保证测试粒度足够小，有助于精确定位问题。单测粒度至多是类级别，一般是方法级别。单测不负责检查跨类或者跨系统的交互逻辑，那是集成测试的领域。

#### 基本目标

- 语句覆盖率达到70%;核心模块的语句覆盖率和分支覆盖率都要达到100%


### 测试方案

- 基于

  JSDOM

  - **优点**：快，执行速度最快，因为不需要浏览器启动
  - **缺点**：无法测试如seesion或cookie等相关操作，并且由于不是真实浏览器环境因此无法保证一些如Dom相关和BOM相关的操作的正确性，并且JSDOM未实现localStorage，如果需要进行覆盖，只能使用第三方库如[node-localStorage](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Flmaccherone%2Fnode-localstorage) （这个库本身对与执行环境的判断有一些问题）进行模拟。

- 基于

  PhantomJs

  等无头浏览器

  - **优点**: 相对较快，并且具有真实的DOM环境
  - **缺点**: 同样不在真实浏览器中运行，难以调试，并且项目issue非常多，puppeteer发布后作者宣布不再维护

- 使用Karma或puppeteer等工具，调用真实的浏览器环境进行测试

  - **优点**：配置简单，能在真实的浏览器中运行测试，并且karma能将测试代码在多个浏览器中运行,同时方便调试
  - **缺点**: 唯一的缺点就是相对前两者运行稍慢，但是在单元测试可接受范围内

### 测试框架和相关工具

- 测试平台
  - [karma](https://link.juejin.im/?target=https%3A%2F%2Fkarma-runner.github.io%2F2.0%2Findex.html) – Google Angular团队开发的测试运行平台，配置简单灵活，能够很方便将测试在多个真实浏览器中运行。

- 测试框架
  - [mocha](https://link.juejin.im/?target=https%3A%2F%2Fmochajs.org%2F) – Tj大神开发的很优秀的测试框架，有完善的生态系统，简单的测试组织方式，不对断言库和工具做任何限制，非常灵活。
  - [jasmine](https://link.juejin.im/?target=https%3A%2F%2Fjasmine.github.io%2F) – 和Mocha语法非常相似，最大的差别是提供了自建的断言和Spy和Stub
  - [jest](https://link.juejin.im/?target=https%3A%2F%2Ffacebook.github.io%2Fjest%2F) – facebook出品的大而全的测试框架，React官方推荐的单元测试框架，配置简单运行速度快。（备注：无法和Karma进行集成）
  - [AVA](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Favajs%2Fava) – 和上面的测试框架最大的区别在于多线程，运行速度更快。
  - 其他 – 还有一些其他的前端测试框架，但是相似度比较高，无非是对断言和测试桩等工具的集成度不同，如果考虑稳定以及成熟度建议选择Mocha，对测试运行速度有非常高的要求可以考虑jest和AVA
- 测试辅助工具
  - 断言库 – [Chai](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Fchaijs%2Fchai) 如果单元测试不跑在真实的浏览器环境中，可以简单使用node的assert，但是建议使用Chai作为断言库（提供了TDD和BDD风格多种断言方式，并且生态系统繁荣）。
  - 测试桩（又称为测试替身） – [Sinon](https://link.juejin.im/?target=http%3A%2F%2Fsinonjs.org%2F)、[testDouble](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Ftestdouble%2Ftestdouble.js%2F)等工具提供了如测试桩、拦截模拟请求、”时间旅行“等功能，主要用于解决”函数不纯”（比如测试回调是否被正确调用，XHR是否正确发起请求，时间延迟后函数行为是否正确）的测试问题。
- 测试覆盖率工具
  - [istanbul](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Fgotwarlost%2Fistanbul) istanbul的基础实现，提供了命令行等工具，但是无法解决代码编译打点的问题
  - [istanbul-instrumenter-loader](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Fwebpack-contrib%2Fistanbul-instrumenter-loader) istanbul的Webpack插件，能解决代码编译打点和测试报告输出的问题

### 测试建议

- 编写测试代码时,建议以一种利于重构的方式去写,更多关注输入输出结果,保证工作正常,而不是对无关紧要的细节进行限制
- 只对稳定的、需求确定的项目进行测试
- 优先保证核心链路
- 自动化测试不是银弹,重构不能完全依赖测试

### 测试方法论

#### TDD(Test-driven-development)测试驱动开发

其基**本思路是通过测试来推动整个开发进行**;测试优先编写代码

单元测试的首要目的**不是为了能够编写出大量覆盖率的全部通过的测试代码,**而是需要从使用者(调用者)的角度出发,尝试函数逻辑的各种可能性

测试不是手段是目的.测试主要**目的不是证明代码正确,而是帮助发现错误**

##### 过程

红灯(代码还不完善,测试挂)-绿灯(编写代码,测试通过) -重构(优化代码并保证测试通过)

需求分析，思考实现

1. 先写功能的测试
2. 实现功能代码
3. 提交代码
4. 重构功能代码



#### BDD(Behavior-driven development)行为驱动开发

设计测试用例的时候对系统进行定义,倡导使用通用的语言将系统行为描述出来,将系统设计和测试用例结合起来

1. 从业务的角度定义具体的，以及可衡量的目标
2. 找到一种可以达到设定目标的、对业务最重要的那些功能的方法
3. 然后像故事一样描述出一个个具体可执行的行为。其描述方法基于一些通用词汇，这些词汇具有准确无误的表达能力和一致的含义。例如，`expect`, `should`, `assert`
4. 寻找合适语言及方法，对行为进行实现
5. 测试人员检验产品运行结果是否符合预期行为。最大程度的交付出符合用户期望的产品，避免表达不一致带来的问题

## react测试

### Jest

Facebook 开源的集成测试框架，功能也十分强大，内置 Jasmine，Istanbul 等能力

特点

- 基于 snapshot 的 React 渲染结果测试（因为 snapshot 常会因任何前端改动而改变，相比于 enzyme 不够灵活，不过本身 enzyme 支持 Jest）
- 类似 Sinon 等工具库
- 内置 jsdom，可以执行脚本、操作 DOM
- 精确到行的命令行异常提示
- 支持覆盖率测试

### Enzyme

Airbnb 出品的 React 组件测试工具，可以方便地测试组件输出，遍历、操作 React Tree。对于测试 React 组件的场景能很好满足（如果对测试环境有更多要求，例如需要支持界面渲染，触发 resize、拖拽等复杂事件，请选择端到端测试工具）

特点

- jQuery 风格 API
- 提供 setProps、setState、setContext 等 React 模型内方法，以及 click、type 等事件模拟
- 支持渲染静态 HTML、shallow（虚拟的 React Tree，会调用生命周期方法，不能测试子组件）、基于 jsdom 的无头浏览器 DOM 渲染

## 参考

###### [react-jest测试](<https://www.robinwieruch.de/react-testing-tutorial/#react-mocha-chai-test-setup>)


